IF OBJECT_ID('tempdb..#tmptable') IS NOT NULL DROP TABLE #tmptable;
WITH cteLR AS (SELECT CONVERT(VARCHAR(6),a.TanggalBukti,112) as TahunBulan,a.KodeCompany,a.KodeAkun,b.Keterangan,
SUM(CASE WHEN a.DebetOrKredit<>b.DebetOrKredit THEN -a.Jumlah ELSE a.Jumlah END) AS Jumlah 
FROM dbo.tbACJurnal a 
LEFT JOIN dbo.tbACKodeAkun b ON b.KodeAkun=a.KodeAkun 
WHERE CONVERT(VARCHAR(6),a.TanggalBukti,112) in ('202012') AND a.KodeCompany in ('21') AND b.IdKategori 
IN (SELECT IdKategori FROM dbo.tbACKategori WHERE StatusLaporan='LR') 
GROUP BY CONVERT(VARCHAR(6),a.TanggalBukti,112),a.KodeCompany,a.KodeAkun, b.Keterangan, b.DebetOrKredit),
ctenpmtahunbulan as(
select '202012' as TahunBulan,substring(KodeAkun,1,2) as KodeCompany,KodeAkun,Aliasing,Grup from tbACKategoriNPM 
group by KodeAkun,Aliasing,Grup
having substring(KodeAkun,1,3) in ('21.')
),
ctepvot as(
select a.TahunBulan,a.KodeAkun,a.KodeCompany,a.Aliasing,a.Grup,b.Keterangan,c.Jumlah as JumlahNPM from ctenpmtahunbulan a
left join tbACKodeAkun b on b.KodeAkun = a.KodeAkun
left join cteLR c on c.KodeAkun = a.KodeAkun
WHERE NOT c.KodeAkun IN (a.kodecompany+'.90.20.210',a.kodecompany+'.90.20.971',a.kodecompany+'.90.20.972',a.kodecompany+'.90.20.973',
a.kodecompany+'.90.20.974',a.kodecompany+'.90.10.610',a.kodecompany+'.90.10.620',a.KodeCompany+'.60.01.100',a.kodecompany+'.90.10.630')
), 
cteall as(
select '202012' as TahunBulan, Aliasing,Grup from tbACKategoriNPM group by Aliasing,Grup ),
cteall2 as(
select a.TahunBulan,a.Aliasing, sum(isnull(b.JumlahNPM,0)) as JumlahNPM,a.Grup 
from cteall a 
left join ctepvot b on b.Aliasing = a.Aliasing and b.TahunBulan = a.TahunBulan 
group by a.Aliasing,a.Grup,a.TahunBulan ),
ctegabung as(
select * from cteall2 
union all 
select a.TahunBulan,'PENDAPATAN BERSIH' as Aliasing,(select isnull ((select sum(x.JumlahNPM) from cteall2 x 
group by x.TahunBulan,x.grup having x.TahunBulan=a.TahunBulan and x.Grup='1.0'),0))-(
select isnull((select sum(x.JumlahNPM) from cteall2 x group by x.TahunBulan,x.grup having x.TahunBulan=a.TahunBulan and x.Grup='2.0'),0)) as Jumlah, 
2.1 as Grup from ctepvot a group by a.TahunBulan 
union all 
select a.TahunBulan,'TOTAL HPP BARANG DAGANG' as Aliasing,(select isnull((select sum(x.JumlahNPM) from cteall2 x 
group by x.TahunBulan,x.grup having x.TahunBulan=a.TahunBulan and x.Grup='3.0'),0)) as Jumlah, 
3.1 as Grup from ctepvot a group by a.TahunBulan 
union all 
select a.TahunBulan,'LABA-RUGI KOTOR' as Aliasing,((select isnull((select sum(x.JumlahNPM) from 
cteall2 x group by x.TahunBulan,x.grup having x.TahunBulan=a.TahunBulan and x.Grup='1.0'),0))-(
select isnull((select sum(x.JumlahNPM) from cteall2 x group by x.TahunBulan,x.grup having x.TahunBulan=a.TahunBulan and x.Grup='2.0'),0)))-(
select isnull((select sum(x.JumlahNPM) from cteall2 x group by x.TahunBulan,x.grup having x.TahunBulan=a.TahunBulan and x.Grup='3.0'),0)) as Jumlah, 
3.2 as Grup from ctepvot a group by a.TahunBulan 
union all 
select a.TahunBulan,'TOTAL BEBAN USAHA' as Aliasing,(select isnull((select sum(x.JumlahNPM) from cteall2 x group by x.TahunBulan,x.grup 
having x.TahunBulan=a.TahunBulan and x.Grup='4.0'),0)) as Jumlah, 4.1 as Grup from ctepvot a group by a.TahunBulan 
union all 
select a.TahunBulan,'LABA-RUGI OPERASI' as Aliasing,(select isnull((select sum(x.JumlahNPM) from cteall2 x 
group by x.TahunBulan,x.grup having x.TahunBulan=a.TahunBulan and x.Grup='1.0'),0))-(select isnull((select sum(x.JumlahNPM) from cteall2 x 
group by x.TahunBulan,x.grup having x.TahunBulan=a.TahunBulan and x.Grup='2.0'),0))-(select isnull((select sum(x.JumlahNPM) from cteall2 x 
group by x.TahunBulan,x.grup having x.TahunBulan=a.TahunBulan and x.Grup='3.0'),0))-(select isnull((select sum(x.JumlahNPM) from cteall2 x 
group by x.TahunBulan,x.grup having x.TahunBulan=a.TahunBulan and x.Grup='4.0'),0)) as Jumlah, 4.2 as Grup from ctepvot a group by a.TahunBulan 
union all 
select a.TahunBulan,'TOTAL PENDAPATAN & BIAYA DILUAR USAHA' as Aliasing,(select isnull((select sum(x.JumlahNPM) from cteall2 x 
group by x.TahunBulan,x.grup having x.TahunBulan=a.TahunBulan and x.Grup='5.0'),0))-(select isnull((select sum(x.JumlahNPM) from cteall2 x 
group by x.TahunBulan,x.grup having x.TahunBulan=a.TahunBulan and x.Grup='6.0'),0)) as Jumlah, 6.1 as Grup from ctepvot a 
group by a.TahunBulan 
union all
select a.TahunBulan,'LABA-RUGI SEBELUM PAJAK' as Aliasing,((select isnull((select sum(x.JumlahNPM) from cteall2 x group by x.TahunBulan,x.grup 
having x.TahunBulan=a.TahunBulan and x.Grup='1.0'),0))-(select isnull((select sum(x.JumlahNPM) from cteall2 x group by x.TahunBulan,x.grup 
having x.TahunBulan=a.TahunBulan and x.Grup='2.0'),0))-(select isnull((select sum(x.JumlahNPM) from cteall2 x group by x.TahunBulan,x.grup 
having x.TahunBulan=a.TahunBulan and x.Grup='3.0'),0))-(select isnull((select sum(x.JumlahNPM) from cteall2 x group by x.TahunBulan,x.grup 
having x.TahunBulan=a.TahunBulan and x.Grup='4.0'),0)))+(select isnull((select sum(x.JumlahNPM) from cteall2 x group by x.TahunBulan,x.grup 
having x.TahunBulan=a.TahunBulan and x.Grup='5.0'),0))-(select isnull((select sum(x.JumlahNPM) from cteall2 x group by x.TahunBulan,x.grup 
having x.TahunBulan=a.TahunBulan and x.Grup='6.0'),0)) as Jumlah, 6.2 as Grup from ctepvot a group by a.TahunBulan 
union all 
select a.TahunBulan,'LABA-RUGI SETELAH PAJAK' as Aliasing,((
select isnull((select sum(x.JumlahNPM) from cteall2 x group by x.TahunBulan,x.grup having x.TahunBulan=a.TahunBulan and x.Grup='1.0'),0))-(
select isnull((select sum(x.JumlahNPM) from cteall2 x group by x.TahunBulan,x.grup having x.TahunBulan=a.TahunBulan and x.Grup='2.0'),0))- (
select isnull((select sum(x.JumlahNPM) from cteall2 x group by x.TahunBulan,x.grup having x.TahunBulan=a.TahunBulan and x.Grup='3.0'),0))-(
select isnull((select sum(x.JumlahNPM) from cteall2 x group by x.TahunBulan,x.grup having x.TahunBulan=a.TahunBulan and x.Grup='4.0'),0)))+(
select isnull((select sum(x.JumlahNPM) from cteall2 x group by x.TahunBulan,x.grup having x.TahunBulan=a.TahunBulan and x.Grup='5.0'),0))-(
select isnull((select sum(x.JumlahNPM) from cteall2 x group by x.TahunBulan,x.grup having x.TahunBulan=a.TahunBulan and x.Grup='6.0'),0))-(
select isnull((select sum(x.JumlahNPM) from cteall2 x group by x.TahunBulan,x.grup having x.TahunBulan=a.TahunBulan and x.Grup='7.0'),0)) as Jumlah, 
7.1 as Grup from ctepvot a group by a.TahunBulan ),
ctejml as(
select SUBSTRING(a.TahunBulan,1,4) as Tahun,a.Aliasing,sum(a.JumlahNPM) as Jumlah, sum(a.JumlahNPM)/1 as Rata, 
(sum(a.JumlahNPM)/1) / (select sum(x.JumlahNPM)/1 from ctegabung x 
where SUBSTRING(x.TahunBulan,1,4)=SUBSTRING(a.TahunBulan,1,4) and x.Aliasing='PENDAPATAN BERSIH') * 100 as Persen,Grup from 
ctegabung a group by SUBSTRING(a.TahunBulan,1,4),a.Aliasing,a.Grup) 
select * into #tmptable from ctejml; 
with ctepivotrealisasi as(
select P.Aliasing,sum(isnull(p.[2020],0)) as Realisasi2020,Grup from #tmptable D 
PIVOT(Sum(Jumlah) FOR D.Tahun IN ([2020])) P group by Aliasing,Grup),
cterata as(
select P.Aliasing,sum(isnull(p.[2020],0)) as Rata2020,Grup from #tmptable D 
PIVOT(max(Rata) FOR D.Tahun IN ([2020])) P group by Aliasing,Grup),
ctepersen as(
select P.Aliasing,sum(isnull(p.[2020],0)) as Persen2020,Grup from #tmptable D 
PIVOT(max(Persen) FOR D.Tahun IN ([2020])) P group by Aliasing,Grup)
select a.Aliasing as Keterangan,a.Realisasi2020 as [Realisasi2020(Rp)],b.Rata2020 as [Rata2020(Rp)],c.Persen2020 as [Persen2020(%)], 0 as [Selisih(%)] ,
a.Grup from ctepivotrealisasi a 
left join cterata b on b.Aliasing = a.Aliasing and b.Grup = a.Grup 
left join ctepersen c on c.Aliasing = a.Aliasing and c.Grup = a.Grup order by a.Grup
